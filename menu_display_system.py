#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Sistema de formateo y display de men√∫s para Telegram
Optimizado para mostrar estructura de timing nutricional
"""

import json
from typing import Dict, List, Any, Optional
from datetime import datetime, timedelta

def format_menu_for_telegram(user_profile: Dict) -> str:
    """
    Formatear men√∫ semanal personalizado para Telegram
    Integra timing nutricional y complementos mediterr√°neos
    """
    try:
        # Datos del usuario
        basic_data = user_profile["basic_data"]
        macros = user_profile["macros"]
        energy_data = user_profile["energy_data"]
        
        # Encabezado del men√∫
        menu_text = f"""
üìÖ **MEN√ö SEMANAL PERSONALIZADO**

üë§ **Tu perfil:** {basic_data['objetivo_descripcion']}
üî• **Calor√≠as diarias:** {macros['calories']} kcal
‚ö° **Available Energy:** {energy_data['available_energy']} kcal/kg FFM/d√≠a
üéØ **Estado:** {energy_data['ea_status']['color']} {energy_data['ea_status']['description']}

**ESTRUCTURA DE TIMING NUTRICIONAL:**

"""
        
        # Generar distribuci√≥n diaria por timing
        daily_structure = generate_daily_timing_structure(user_profile)
        
        # Formatear cada comida del d√≠a
        for meal in ["desayuno", "almuerzo", "merienda", "cena"]:
            if meal not in daily_structure:
                continue
                
            details = daily_structure[meal]
            timing_type = details.get('timing_type', 'comida_principal')
            
            # Nombre de la comida con timing din√°mico
            meal_name = format_timing_name(meal)
            
            # Agregar etiqueta de timing si es pre o post entreno
            if timing_type == "pre_entreno":
                menu_text += f"**{meal_name} & PRE-ENTRENO:**\n"
            elif timing_type == "post_entreno":
                menu_text += f"**{meal_name} & POST-ENTRENO:**\n"
            else:
                menu_text += f"**{meal_name}:**\n"
            
            # Descripci√≥n del timing
            menu_text += f"_{details['description']}_\n"
            
            # Macros objetivo para este timing
            target_macros = details['target_macros']
            menu_text += f"üéØ Target: {target_macros['calories']} kcal ‚Ä¢ "
            menu_text += f"{target_macros['protein']}P ‚Ä¢ {target_macros['carbs']}C ‚Ä¢ {target_macros['fat']}F\n"
            
            # Recetas recomendadas
            recipes = details.get('recipes', [])
            if recipes:
                menu_text += "üçΩÔ∏è **Opciones:**\n"
                for recipe in recipes[:2]:  # M√°ximo 2 opciones por timing
                    menu_text += f"  ‚Ä¢ {recipe['name']} ({recipe['calories']} kcal)\n"
            
            # Complementos mediterr√°neos
            complements = details.get('complements', [])
            if complements:
                menu_text += "ü•ú **Complementos:**\n"
                for complement in complements:
                    menu_text += f"  ‚Ä¢ {complement['name']} {complement['portion']}\n"
            
            menu_text += "\n"
        
        # Resumen diario
        menu_text += generate_daily_summary(user_profile)
        
        # Recomendaciones personalizadas
        menu_text += generate_personalized_recommendations(user_profile)
        
        return menu_text
        
    except Exception as e:
        return f"‚ùå Error generating menu: {str(e)}"

def generate_daily_timing_structure(user_profile: Dict) -> Dict:
    """
    Generar estructura de timing diario personalizada basada en el horario de entrenamiento
    """
    objective = user_profile["basic_data"]["objetivo"]
    daily_calories = user_profile["macros"]["calories"]
    
    # Obtener el timing din√°mico del perfil del usuario
    exercise_profile = user_profile.get("exercise_profile", {})
    dynamic_meal_timing = exercise_profile.get("dynamic_meal_timing", {
        "desayuno": "comida_principal",
        "almuerzo": "comida_principal", 
        "merienda": "snack_complemento",
        "cena": "comida_principal"
    })
    training_schedule = exercise_profile.get("training_schedule", "variable")
    
    # Distribuci√≥n de calor√≠as equilibrada para 4 comidas
    calorie_distributions = {
        "bajar_peso": {
            "desayuno": 0.25,    # 25%
            "almuerzo": 0.35,    # 35% - Mayor comida
            "merienda": 0.15,    # 15% - Snack
            "cena": 0.25         # 25%
        },
        "subir_masa": {
            "desayuno": 0.25,
            "almuerzo": 0.30,
            "merienda": 0.15,
            "cena": 0.30
        },
        "recomposicion": {
            "desayuno": 0.25,
            "almuerzo": 0.35,
            "merienda": 0.15,
            "cena": 0.25
        },
        "mantener": {
            "desayuno": 0.25,
            "almuerzo": 0.30,
            "merienda": 0.15,
            "cena": 0.30
        }
    }
    
    distribution = calorie_distributions.get(objective, calorie_distributions["mantener"])
    
    # Obtener horarios seg√∫n entrenamiento
    timing_hours = get_timing_hours_by_schedule(training_schedule)
    
    # Estructura din√°mica de timing
    timing_structure = {}
    
    for meal in ["desayuno", "almuerzo", "merienda", "cena"]:
        timing_type = dynamic_meal_timing.get(meal, "comida_principal")
        
        timing_structure[meal] = {
            "description": get_meal_description(meal, timing_type, timing_hours[meal]),
            "target_macros": calculate_timing_macros(
                daily_calories * distribution[meal],
                timing_type
            ),
            "recipes": get_timing_recipes(timing_type),
            "complements": get_timing_complements(meal),
            "timing_type": timing_type
        }
    
    return timing_structure

def calculate_timing_macros(target_calories: float, timing_type: str) -> Dict:
    """
    Calcular distribuci√≥n de macros para un timing espec√≠fico
    """
    # Distribuciones por timing
    macro_ratios = {
        "pre_entreno": {"protein": 0.15, "carbs": 0.70, "fat": 0.15},
        "post_entreno": {"protein": 0.35, "carbs": 0.45, "fat": 0.20},
        "comida_principal": {"protein": 0.25, "carbs": 0.45, "fat": 0.30},
        "snack_complemento": {"protein": 0.20, "carbs": 0.40, "fat": 0.40}
    }
    
    ratios = macro_ratios.get(timing_type, macro_ratios["comida_principal"])
    
    return {
        "calories": int(target_calories),
        "protein": int((target_calories * ratios["protein"]) / 4),
        "carbs": int((target_calories * ratios["carbs"]) / 4),
        "fat": int((target_calories * ratios["fat"]) / 9)
    }

def get_timing_recipes(timing_type: str) -> List[Dict]:
    """
    Obtener recetas ejemplo para cada timing
    """
    recipe_examples = {
        "pre_entreno": [
            {"name": "Tostada integral con miel y pl√°tano", "calories": 280},
            {"name": "Smoothie de frutas con avena", "calories": 320}
        ],
        "post_entreno": [
            {"name": "Pollo con quinoa y verduras", "calories": 520},
            {"name": "Salm√≥n con arroz integral", "calories": 480}
        ],
        "comida_principal": [
            {"name": "Ternera mediterr√°nea con legumbres", "calories": 580},
            {"name": "Lubina al horno con vegetales", "calories": 450}
        ]
    }
    
    return recipe_examples.get(timing_type, [])

def get_timing_complements(meal_time: str) -> List[Dict]:
    """
    Obtener complementos mediterr√°neos para cada momento
    """
    complements_by_time = {
        "desayuno": [
            {"name": "Almendras crudas", "portion": "20g"},
            {"name": "Miel cruda", "portion": "15g"}
        ],
        "almuerzo": [
            {"name": "Yogur griego natural", "portion": "150g"},
            {"name": "Nueces", "portion": "15g"}
        ],
        "merienda": [
            {"name": "Pistachos", "portion": "25g"},
            {"name": "Higos secos", "portion": "2 unidades"}
        ],
        "cena": [
            {"name": "Aceitunas kalamata", "portion": "20g"},
            {"name": "Queso feta", "portion": "30g"}
        ],
        "snacks": [
            {"name": "Aceite oliva virgen extra", "portion": "10ml"},
            {"name": "Frutos secos mixtos", "portion": "20g"}
        ]
    }
    
    return complements_by_time.get(meal_time, [])

def get_timing_hours_by_schedule(training_schedule: str) -> Dict[str, str]:
    """
    Obtener horarios recomendados para cada comida seg√∫n horario de entrenamiento
    """
    schedule_hours = {
        "ma√±ana": {  # Entrenamiento 6:00-12:00
            "desayuno": "6:30-8:00",
            "almuerzo": "12:30-14:00", 
            "merienda": "16:00-17:00",
            "cena": "20:00-21:30"
        },
        "mediodia": {  # Entrenamiento 12:00-16:00
            "desayuno": "7:00-8:30",
            "almuerzo": "11:30-12:00",
            "merienda": "16:30-17:30",
            "cena": "20:00-21:30"
        },
        "tarde": {  # Entrenamiento 16:00-20:00
            "desayuno": "7:00-8:30",
            "almuerzo": "12:00-14:00", 
            "merienda": "15:30-16:00",
            "cena": "20:30-22:00"
        },
        "noche": {  # Entrenamiento 20:00-24:00
            "desayuno": "7:00-8:30",
            "almuerzo": "12:00-14:00",
            "merienda": "16:00-17:00",
            "cena": "19:30-20:00"
        },
        "variable": {  # Horario variable
            "desayuno": "7:00-9:00",
            "almuerzo": "12:00-14:00",
            "merienda": "16:00-17:00",
            "cena": "20:00-21:30"
        }
    }
    
    return schedule_hours.get(training_schedule, schedule_hours["variable"])

def get_meal_description(meal: str, timing_type: str, hour_range: str) -> str:
    """
    Generar descripci√≥n de comida seg√∫n su funci√≥n nutricional
    """
    timing_descriptions = {
        "pre_entreno": "Energ√≠a r√°pida pre-entreno",
        "post_entreno": "Recuperaci√≥n post-entreno",
        "comida_principal": "Comida balanceada",
        "snack_complemento": "Snack complemento"
    }
    
    base_description = timing_descriptions.get(timing_type, "Comida balanceada")
    return f"{base_description} ({hour_range})"

def format_timing_name(timing_key: str) -> str:
    """
    Formatear nombres de timing para display din√°mico
    """
    meal_icons = {
        "desayuno": "üåÖ",
        "almuerzo": "üçΩÔ∏è", 
        "merienda": "ü•ú",
        "cena": "üåô"
    }
    
    meal_names = {
        "desayuno": "DESAYUNO",
        "almuerzo": "ALMUERZO",
        "merienda": "MERIENDA", 
        "cena": "CENA"
    }
    
    # Si es una de las 4 comidas principales, usar formato din√°mico
    if timing_key in meal_icons:
        return f"{meal_icons[timing_key]} {meal_names[timing_key]}"
    
    # Fallback para nombres antiguos
    timing_names = {
        "desayuno_pre": "üåÖ DESAYUNO & PRE-ENTRENO",
        "almuerzo_post": "üçΩÔ∏è ALMUERZO & POST-ENTRENO", 
        "cena_principal": "üåô CENA PRINCIPAL",
        "complementos": "ü•ú COMPLEMENTOS MEDITERR√ÅNEOS"
    }
    
    return timing_names.get(timing_key, timing_key.upper())

def generate_daily_summary(user_profile: Dict) -> str:
    """
    Generar resumen diario del men√∫
    """
    macros = user_profile["macros"]
    energy_data = user_profile["energy_data"]
    
    summary = f"""
üìä **RESUMEN DIARIO COMPLETO:**

üéØ **Macros objetivo totales:**
‚Ä¢ {macros['calories']} kcal diarias
‚Ä¢ {macros['protein_g']}g prote√≠na ({int(macros['protein_g']*4)} kcal)
‚Ä¢ {macros['carbs_g']}g carbohidratos ({int(macros['carbs_g']*4)} kcal)
‚Ä¢ {macros['fat_g']}g grasas ({int(macros['fat_g']*9)} kcal)

‚ö° **An√°lisis energ√©tico:**
‚Ä¢ Available Energy: {energy_data['available_energy']} kcal/kg FFM/d√≠a
‚Ä¢ TDEE: {energy_data['tdee']} kcal
‚Ä¢ Ejercicio diario: {energy_data['daily_exercise_calories']} kcal
‚Ä¢ Estado: {energy_data['ea_status']['description']}

"""
    
    return summary

def generate_personalized_recommendations(user_profile: Dict) -> str:
    """
    Generar recomendaciones personalizadas
    """
    objective = user_profile["basic_data"]["objetivo"]
    ea_status = user_profile["energy_data"]["ea_status"]["status"]
    
    recommendations = f"""
üí° **RECOMENDACIONES PERSONALIZADAS:**

**Para tu objetivo ({user_profile['basic_data']['objetivo_descripcion']}):**
"""
    
    # Recomendaciones por objetivo
    objective_recommendations = {
        "bajar_peso": [
            "‚Ä¢ Prioriza prote√≠na en cada comida para preservar masa muscular",
            "‚Ä¢ Consume carbohidratos principalmente pre/post entreno",
            "‚Ä¢ Incluye grasas saludables para saciedad y hormonas"
        ],
        "subir_masa": [
            "‚Ä¢ Asegura surplus cal√≥rico constante con alimentos densos",
            "‚Ä¢ Maximiza ventana anab√≥lica post-entreno",
            "‚Ä¢ Distribuye prote√≠na uniformemente durante el d√≠a"
        ],
        "recomposicion": [
            "‚Ä¢ Timing nutricional preciso para maximizar partici√≥n",
            "‚Ä¢ Carbohidratos estrat√©gicos alrededor del entrenamiento",
            "‚Ä¢ Mant√©n Available Energy en zona √≥ptima"
        ],
        "mantener": [
            "‚Ä¢ Equilibrio perfecto entre todos los macronutrientes",
            "‚Ä¢ Enfoque en calidad y variedad de alimentos",
            "‚Ä¢ Mant√©n rutinas consistentes"
        ]
    }
    
    for rec in objective_recommendations.get(objective, []):
        recommendations += f"{rec}\n"
    
    # Recomendaciones por Available Energy
    recommendations += "\n**Por tu Available Energy:**\n"
    ea_recommendation = user_profile["energy_data"]["ea_status"]["recommendation"]
    recommendations += f"‚Ä¢ {ea_recommendation}\n"
    
    # Comandos disponibles
    recommendations += f"""

ü§ñ **PR√ìXIMOS PASOS:**
‚Ä¢ `/generar` - Crear recetas espec√≠ficas por timing
‚Ä¢ `/buscar [plato]` - Encontrar recetas con IA
‚Ä¢ `/complementos` - Ver todos los complementos mediterr√°neos
‚Ä¢ `/nueva_semana` - Configurar rotaci√≥n semanal

**Tu men√∫ se adapta autom√°ticamente a tu progreso y feedback.**
"""
    
    return recommendations

def format_shopping_list(user_profile: Dict) -> str:
    """
    Formatear lista de compras semanal
    """
    shopping_text = f"""
üõí **LISTA DE COMPRAS SEMANAL**

üë§ **Optimizada para:** {user_profile['basic_data']['objetivo_descripcion']}
üî• **Calor√≠as diarias:** {user_profile['macros']['calories']} kcal

**PROTE√çNAS PRINCIPALES:**
‚Ä¢ Pechuga de pollo: 1.5 kg
‚Ä¢ Salm√≥n fresco: 600g
‚Ä¢ Huevos frescos: 2 docenas
‚Ä¢ Yogur griego natural: 1 kg

**CARBOHIDRATOS COMPLEJOS:**
‚Ä¢ Quinoa: 400g
‚Ä¢ Arroz integral: 800g
‚Ä¢ Avena integral: 500g
‚Ä¢ Pan integral: 2 barras

**VERDURAS Y VEGETALES:**
‚Ä¢ Br√≥coli: 800g
‚Ä¢ Espinacas frescas: 400g
‚Ä¢ Tomates: 1 kg
‚Ä¢ Pimientos mixtos: 600g

ü•ú **COMPLEMENTOS MEDITERR√ÅNEOS:**
‚Ä¢ Almendras crudas: 200g
‚Ä¢ Nueces: 150g
‚Ä¢ Aceitunas kalamata: 200g
‚Ä¢ Queso feta: 250g
‚Ä¢ Miel cruda: 1 bote
‚Ä¢ Aceite oliva virgen extra: 500ml

**HIERBAS Y ESPECIAS:**
‚Ä¢ Or√©gano seco
‚Ä¢ Tomillo fresco
‚Ä¢ Ajo fresco: 2 cabezas
‚Ä¢ Jengibre: 1 ra√≠z

üí° **Esta lista cubre 5 d√≠as de meal prep seg√∫n tu perfil nutricional.**
"""
    
    return shopping_text

def format_cooking_schedule(user_profile: Dict) -> str:
    """
    Formatear cronograma de cocci√≥n
    """
    cooking_text = f"""
‚è∞ **CRONOGRAMA DE MEAL PREP**

üéØ **Optimizado para:** {user_profile['basic_data']['objetivo_descripcion']}
üìÖ **Modalidad:** Dos sesiones semanales

**SESI√ìN 1 - DOMINGO (10:00-13:00)**
‚è±Ô∏è **Duraci√≥n:** 3 horas
üìã **Tareas:**
‚Ä¢ Cocinar prote√≠nas principales (pollo, salm√≥n)
‚Ä¢ Preparar quinoa y arroz integral
‚Ä¢ Lavar y cortar todas las verduras
‚Ä¢ Preparar complementos mediterr√°neos en porciones

**SESI√ìN 2 - MI√âRCOLES (19:00-21:00)**
‚è±Ô∏è **Duraci√≥n:** 2 horas
üìã **Tareas:**
‚Ä¢ Reabastecer verduras frescas
‚Ä¢ Preparar recetas de media semana
‚Ä¢ Revisar y reorganizar contenedores
‚Ä¢ Preparar complementos restantes

**DISTRIBUCI√ìN SEMANAL:**
üì¶ **Lunes-Martes:** Comidas de sesi√≥n domingo
üì¶ **Mi√©rcoles-Jueves:** Comidas frescas de sesi√≥n mi√©rcoles
üì¶ **Viernes:** Combinaci√≥n optimizada

üí° **Ventajas de este cronograma:**
‚Ä¢ Comidas siempre frescas (m√°ximo 3 d√≠as)
‚Ä¢ Carga de trabajo distribuida
‚Ä¢ Flexibilidad para ajustes mid-week
‚Ä¢ √ìptimo para tu Available Energy
"""
    
    return cooking_text

# Ejemplo de uso
if __name__ == "__main__":
    # Ejemplo de perfil de usuario
    sample_profile = {
        "basic_data": {
            "objetivo": "subir_masa",
            "objetivo_descripcion": "Ganar m√∫sculo minimizando grasa"
        },
        "macros": {
            "calories": 2800,
            "protein_g": 180,
            "carbs_g": 300,
            "fat_g": 100
        },
        "energy_data": {
            "available_energy": 52.5,
            "tdee": 2600,
            "daily_exercise_calories": 450,
            "ea_status": {
                "status": "optimal",
                "color": "üü¢",
                "description": "√ìptima para rendimiento y salud",
                "recommendation": "Mant√©n este nivel para m√°ximo rendimiento"
            }
        }
    }
    
    # Generar men√∫ formateado
    menu_formatted = format_menu_for_telegram(sample_profile)
    print(menu_formatted)